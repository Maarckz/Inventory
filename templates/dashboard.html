{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/chart.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
    // Configuração comum para os gráficos
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true,
                    pointStyle: 'circle'
                }
            },
            tooltip: {
                callbacks: {
                    label: function (context) {
                        return `${context.label}: ${context.raw}`;
                    }
                }
            }
        },
        onClick: (event, elements, chart) => {
            if (elements.length > 0) {
                const index = elements[0].index;
                let query = '';
                
                // Tratamento especial para cada tipo de gráfico
                switch(chart.canvas.id) {
                    case 'osChart':
                        query = 'inventory:os:' + chart.data.labels[index].toLowerCase();
                        break;
                    case 'cpuChart':
                        query = 'inventory:hardware:' + chart.data.labels[index].toLowerCase();
                        break;
                    case 'ramChart':
                        const ramLabel = chart.data.labels[index].toLowerCase();
                        query = ramLabel.includes('+') 
                            ? 'ram_gb:>' + ramLabel.replace('+', '').replace('gb', '').trim()
                            : 'ram_gb:' + ramLabel;
                        break;
                    case 'portChart':
                        // Correção para extrair corretamente o número da porta
                        const portLabel = chart.data.labels[index];
                        // Extrai apenas os números do rótulo
                        const portNumber = portLabel.replace(/\D/g, '');
                        if (portNumber) {
                            query = 'ports:' + portNumber;
                        } else {
                            // Fallback seguro
                            query = 'ports:' + portLabel.toLowerCase();
                        }
                        break;
                    case 'processChart':
                        query = 'inventory:processes:' + chart.data.labels[index].toLowerCase();
                        break;
                    default:
                        query = chart.data.labels[index].toLowerCase();
                }
                
                window.location.href = `/search?query=${encodeURIComponent(query)}`;
            }
        }
    };

    // Carregar dados via AJAX
    fetch('/get_chart_data')
        .then(response => response.json())
        .then(data => {
            // Gráfico de Sistemas Operacionais
            const osCtx = document.getElementById('osChart').getContext('2d');
            new Chart(osCtx, {
                type: 'doughnut',
                data: {
                    labels: data.os_labels,
                    datasets: [{
                        data: data.os_data,
                        backgroundColor: [
                            '#6366F1', '#8B5CF6', '#0EA5E9', '#EC4899',
                            '#F43F5E', '#F97316', '#F59E0B'
                        ],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: chartOptions
            });

            // Gráfico de Processadores
            const cpuCtx = document.getElementById('cpuChart').getContext('2d');
            new Chart(cpuCtx, {
                type: 'bar',
                data: {
                    labels: data.cpu_labels,
                    datasets: [{
                        label: 'Quantidade',
                        data: data.cpu_data,
                        backgroundColor: [
                            '#0EA5E9', '#8B5CF6', '#EC4899',
                            '#F43F5E', '#F97316', '#F59E0B',
                            '#10B981', '#3B82F6', '#EAB308',
                            '#A21CAF', '#BE185D', '#8B5CF6'
                        ],
                        borderRadius: 6,
                        borderWidth: 0
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            },
                            ticks: {
                                padding: 10
                            }
                        },
                        x: {
                            display: false,
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function (context) {
                                    return data.cpu_labels[context[0].dataIndex];
                                }
                            }
                        }
                    },
                    layout: {
                        padding: {
                            bottom: 10
                        }
                    }
                }
            });

            // Gráfico de Memória RAM
            const ramCtx = document.getElementById('ramChart').getContext('2d');
            new Chart(ramCtx, {
                type: 'pie',
                data: {
                    labels: data.ram_labels,
                    datasets: [{
                        data: data.ram_data,
                        backgroundColor: [
                            '#EC4899', '#0EA5E9', '#F97316', '#6366F1',
                            '#F43F5E', '#8B5CF6', '#F59E0B', '#10B981',
                            '#3B82F6', '#EAB308', '#A21CAF', '#BE185D',
                            '#22D3EE', '#F472B6', '#34D399', '#FBBF24'
                        ],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: chartOptions
            });

            // Gráfico de Portas de Rede
            const portCtx = document.getElementById('portChart').getContext('2d');
            new Chart(portCtx, {
                type: 'bar',
                data: {
                    labels: data.port_labels,
                    datasets: [{
                        label: 'Ocorrências',
                        data: data.port_data,
                        backgroundColor: '#3B82F6',
                        borderRadius: 6,
                        borderWidth: 0
                    }]
                },
                options: {
                    ...chartOptions,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    // Formata o título do tooltip para mostrar "Porta X"
                                    return 'Porta ' + tooltipItems[0].label.replace(/\D/g, '');
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            }
                        }
                    }
                }
            });

            // Gráfico de Processos em Execução
            const processCtx = document.getElementById('processChart').getContext('2d');
            new Chart(processCtx, {
                type: 'bar',
                data: {
                    labels: data.process_labels,
                    datasets: [{
                        label: 'Ocorrências',
                        data: data.process_data,
                        backgroundColor: '#8B5CF6',
                        borderRadius: 6,
                        borderWidth: 0
                    }]
                },
                options: {
                    ...chartOptions,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            }
                        }
                    }
                }
            });
        });
});

</script>
{% endblock %}
<style>
    /* Novos estilos para a seção de máquinas inativas */
    .inactive-machines-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        padding: 20px;
        margin-top: 30px;
    }

    .section-header {
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
        margin-bottom: 20px;
    }

    .section-header h3 {
        color: #EF4444;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .inactive-machines-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .inactive-machine {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: #FEF2F2;
        border-radius: 8px;
        border-left: 4px solid #EF4444;
    }

    .machine-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .machine-info i {
        font-size: 1.5rem;
        color: #EF4444;
    }

    .machine-details {
        display: flex;
        flex-direction: column;
        gap: 5px;
        color: #6B7280;
        font-size: 0.9rem;
    }

    .btn-view {
        background: #fff;
        color: #EF4444;
        border: 1px solid #EF4444;
        padding: 8px 15px;
        border-radius: 6px;
        text-decoration: none;
        font-size: 0.9rem;
        transition: all 0.3s;
    }

    .btn-view:hover {
        background: #EF4444;
        color: white;
    }

    .no-inactive {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 30px;
        color: #10B981;
        font-weight: 500;
        font-size: 1.1rem;
    }
</style>
{% block content %}
<div class="dashboard-header">
    <div class="dashboard-stats">
        <div class="stat-card stat-primary">
            <div class="stat-icon">
                <i class="fas fa-laptop"></i>
            </div>
            <div class="stat-info">
                <span class="stat-label">Total de Máquinas</span>
                <span class="stat-value">{{ active_count + inactive_count }}</span>
            </div>
        </div>

        <a href="/search?query=agent_info:status:active" style="color: inherit; text-decoration: none;">
            <div class="stat-card stat-success" style="cursor: pointer;">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-label">Ativas</span>
                    <span class="stat-value">
                        {{ active_count }}
                    </span>
                </div>
            </div>
        </a>

        <a href="/search?query=agent_info:status:disconnected" style="color: inherit; text-decoration: none;">
            <div class="stat-card stat-danger" style="cursor: pointer;">
                <div class="stat-icon">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-label">Inativas</span>
                    <span class="stat-value">
                        {{ inactive_count }}
                    </span>
                </div>
            </div>
        </a>
    </div>
</div>

<div class="chart-grid">
    <div class="chart-container">
        <div class="chart-header">
            <h3>Sistemas Operacionais</h3>
        </div>
        <div class="chart-wrapper">
            <canvas id="osChart"></canvas>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-header">
            <h3>Processadores</h3>
        </div>
        <div class="chart-wrapper">
            <canvas id="cpuChart"></canvas>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-header">
            <h3>Memória RAM</h3>
        </div>
        <div class="chart-wrapper">
            <canvas id="ramChart"></canvas>
        </div>
    </div>
</div>
<br>

<!-- Novos gráficos -->
<div class="chart-grid">
    <div class="chart-container">
        <div class="chart-header">
            <h3>Portas de Rede Mais Comuns</h3>
        </div>
        <div class="chart-wrapper">
            <canvas id="portChart"></canvas>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-header">
            <h3>Processos Mais Comuns</h3>
        </div>
        <div class="chart-wrapper">
            <canvas id="processChart"></canvas>
        </div>
    </div>
</div>

{% endblock %}
